From 649b3ff1a5b30dcf1490d7a9a5a9cdef34cb52a2 Mon Sep 17 00:00:00 2001
From: Assam Boudjelthia <assam.boudjelthia@qt.io>
Date: Thu, 18 Sep 2025 18:06:56 +0300
Subject: [PATCH 157/553] Android: call view's onApplyWindowInsets() in
 QtInputDelegate
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This callback was done on the decor view and  wasn't calling the base
onApplyWindowInsets() practically ignoring base insets like system
decorations, this then messes with the default behavior of system
bars making calls to customize color schemes have unexpected
behavior at least or at worse not working at all. Fixing this brings
back the expected behavior of the insets when in the case of the
linked ticket, we would get back correct handling of navigation
bar semi-transparent bars where the bar icons have low contrast
compared to the content below it.

Pick-to: 6.9 6.8
Fixes: QTBUG-139690
Change-Id: I5b46f6f6e0c7850fba117a0ba76d3a693c1cb37b
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit ef10f1e6aa97299d0d9e73e6ed819bbf245d3736)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../src/org/qtproject/qt/android/QtInputDelegate.java  | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java b/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java
index 92bd62cfdcc..ca271c5dd62 100644
--- a/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java
+++ b/src/android/jar/src/org/qtproject/qt/android/QtInputDelegate.java
@@ -94,13 +94,11 @@ class QtInputDelegate implements QtInputConnection.QtInputConnectionListener, Qt
 
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
             View rootView = activity.getWindow().getDecorView();
-            rootView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
-                @Override
-                public WindowInsets onApplyWindowInsets(View v, WindowInsets insets) {
-                    if (m_keyboardIsVisible != insets.isVisible(WindowInsets.Type.ime()))
+            rootView.setOnApplyWindowInsetsListener((view, insets) -> {
+                    WindowInsets windowInsets = view.onApplyWindowInsets(insets);
+                    if (m_keyboardIsVisible != windowInsets.isVisible(WindowInsets.Type.ime()))
                         setKeyboardVisibility_internal(!m_keyboardIsVisible, System.nanoTime());
-                    return insets;
-                }
+                    return windowInsets;
             });
         }
     }
-- 
2.51.2

