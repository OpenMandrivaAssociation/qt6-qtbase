From bb8dc5de08729b571c069093a33bc871eb56377a Mon Sep 17 00:00:00 2001
From: Jacek Poplawski <jacek.poplawski@qt.io>
Date: Wed, 16 Jul 2025 09:48:30 +0200
Subject: [PATCH 008/553] Relax timing check in tst_QMovie::multiFrameImage()
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

ICO images lack animation metadata, so QMoviePrivate::infoForFrame()
assigns a default nextFrameDelay of 1000 ms. QMoviePrivate::next()
scales this value according to playback speed (100 ms), and subtracts
the time spent processing the frame.

The test previously asserted that nextFrameDelay is exactly 100 ms,
which is only true if processing time is zero. On real hardware this
usually holds, but under QEMU (especially for VxWorks Intel), processing
may take 0–40 ms, reducing the effective delay and causing test
failures.

This commit relaxes the strict check, allowing a range of 50–100 ms to
accommodate minor variation in processing overhead.

Pick-to: 6.8 6.9
Task-number: QTBUG-137564
Change-Id: I859612bd2c684df830c5ea8665be1a1763b4f2e0
Reviewed-by: Eirik Aavitsland <eirik.aavitsland@qt.io>
(cherry picked from commit 91d75366d8b72489dc46cd4a274dddd66f25f4be)
---
 tests/auto/gui/image/qmovie/tst_qmovie.cpp | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/tests/auto/gui/image/qmovie/tst_qmovie.cpp b/tests/auto/gui/image/qmovie/tst_qmovie.cpp
index 7f098ba542a..a982e4a805c 100644
--- a/tests/auto/gui/image/qmovie/tst_qmovie.cpp
+++ b/tests/auto/gui/image/qmovie/tst_qmovie.cpp
@@ -332,7 +332,9 @@ void tst_QMovie::multiFrameImage()
     movie.start();
     QTRY_COMPARE(finishedSpy.size(), 1);
     QCOMPARE_GE(playTimer.elapsed(), 100 * expectedFrameCount);
-    QCOMPARE(movie.nextFrameDelay(), 100);
+    const int delay = movie.nextFrameDelay(); // delay is equal to 100ms minus processing time
+    QCOMPARE_GE(delay, 50);
+    QCOMPARE_LE(delay, 100);
     QCOMPARE(errorSpy.size(), 0);
     QCOMPARE(frameChangedSpy.size(), expectedFrameCount);
 }
-- 
2.51.2

