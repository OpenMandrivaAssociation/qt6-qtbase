From a622cf4d8d1a55347255d079d4e4e15225be8584 Mon Sep 17 00:00:00 2001
From: Assam Boudjelthia <assam.boudjelthia@qt.io>
Date: Wed, 1 Oct 2025 00:04:52 +0300
Subject: [PATCH 255/553] Android: guard platform plugin egl code behind
 QT_CONFIG(egl)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Pick-to: 6.8
Fixes: QTBUG-140536
Change-Id: Ic2f3fe3fde80af7b84d8df5cf38e03de6b627112
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit 8fdc771bf00138a22ec0db55b744eb44d813f3cd)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/plugins/platforms/android/CMakeLists.txt  | 17 ++++++++++++-----
 .../android/qandroidplatformintegration.cpp   | 19 +++++++++++++++++++
 .../android/qandroidplatformintegration.h     |  6 ++++++
 .../android/qandroidplatformwindow.cpp        |  1 -
 4 files changed, 37 insertions(+), 6 deletions(-)

diff --git a/src/plugins/platforms/android/CMakeLists.txt b/src/plugins/platforms/android/CMakeLists.txt
index 888baef2bfb..f5e7debbf20 100644
--- a/src/plugins/platforms/android/CMakeLists.txt
+++ b/src/plugins/platforms/android/CMakeLists.txt
@@ -29,9 +29,6 @@ qt_internal_add_plugin(QAndroidIntegrationPlugin
         qandroidplatformmenu.cpp qandroidplatformmenu.h
         qandroidplatformmenubar.cpp qandroidplatformmenubar.h
         qandroidplatformmenuitem.cpp qandroidplatformmenuitem.h
-        qandroidplatformoffscreensurface.cpp qandroidplatformoffscreensurface.h
-        qandroidplatformopenglcontext.cpp qandroidplatformopenglcontext.h
-        qandroidplatformopenglwindow.cpp qandroidplatformopenglwindow.h
         qandroidplatformscreen.cpp qandroidplatformscreen.h
         qandroidplatformservices.cpp qandroidplatformservices.h
         qandroidplatformtheme.cpp qandroidplatformtheme.h
@@ -59,14 +56,12 @@ qt_internal_add_plugin(QAndroidIntegrationPlugin
         ${CMAKE_CURRENT_SOURCE_DIR}
         ${QtBase_SOURCE_DIR}/src/3rdparty/android
     LIBRARIES
-        EGL::EGL
         Qt::Core
         Qt::CorePrivate
         Qt::Gui
         Qt::GuiPrivate
         android
         jnigraphics
-        EGL::EGL
 )
 
 ## Scopes:
@@ -95,6 +90,18 @@ qt_internal_extend_target(QAndroidIntegrationPlugin CONDITION QT_FEATURE_accessi
         androidjniaccessibility.cpp
 )
 
+qt_internal_extend_target(QAndroidIntegrationPlugin CONDITION QT_FEATURE_egl
+    SOURCES
+        qandroidplatformopenglcontext.cpp qandroidplatformopenglcontext.h
+        qandroidplatformopenglwindow.cpp qandroidplatformopenglwindow.h
+        qandroidplatformoffscreensurface.cpp qandroidplatformoffscreensurface.h
+    LIBRARIES
+        EGL::EGL
+    NO_UNITY_BUILD_SOURCES
+        qandroidplatformopenglcontext.cpp qandroidplatformopenglwindow.cpp
+        qandroidplatformoffscreensurface.cpp
+)
+
 qt_internal_extend_target(QAndroidIntegrationPlugin CONDITION QT_FEATURE_vulkan
     SOURCES
         qandroidplatformvulkaninstance.cpp qandroidplatformvulkaninstance.h
diff --git a/src/plugins/platforms/android/qandroidplatformintegration.cpp b/src/plugins/platforms/android/qandroidplatformintegration.cpp
index 012c7cdc653..c6fb60c3358 100644
--- a/src/plugins/platforms/android/qandroidplatformintegration.cpp
+++ b/src/plugins/platforms/android/qandroidplatformintegration.cpp
@@ -17,7 +17,9 @@
 #include "qandroidplatformfontdatabase.h"
 #include "qandroidplatformforeignwindow.h"
 #include "qandroidplatformoffscreensurface.h"
+#if QT_CONFIG(egl)
 #include "qandroidplatformopenglcontext.h"
+#endif
 #include "qandroidplatformopenglwindow.h"
 #include "qandroidplatformscreen.h"
 #include "qandroidplatformservices.h"
@@ -29,7 +31,9 @@
 #include <QOpenGLContext>
 #include <QThread>
 #include <QtCore/QJniObject>
+#if QT_CONFIG(egl)
 #include <QtGui/private/qeglpbuffer_p.h>
+#endif
 #include <QtGui/private/qguiapplication_p.h>
 #include <QtGui/private/qoffscreensurface_p.h>
 #include <QtGui/private/qrhibackingstore_p.h>
@@ -138,6 +142,7 @@ void *QAndroidPlatformNativeInterface::nativeResourceForWindow(const QByteArray
 
 void *QAndroidPlatformNativeInterface::nativeResourceForContext(const QByteArray &resource, QOpenGLContext *context)
 {
+#if QT_CONFIG(egl)
     if (QEGLPlatformContext *platformContext = static_cast<QEGLPlatformContext *>(context->handle())) {
         if (resource == "eglcontext")
             return platformContext->eglContext();
@@ -146,6 +151,10 @@ void *QAndroidPlatformNativeInterface::nativeResourceForContext(const QByteArray
         else if (resource == "egldisplay")
             return platformContext->eglDisplay();
     }
+#else
+    Q_UNUSED(resource)
+    Q_UNUSED(context)
+#endif
     return nullptr;
 }
 
@@ -175,6 +184,7 @@ QAndroidPlatformIntegration::QAndroidPlatformIntegration(const QStringList &para
     Q_UNUSED(paramList);
     m_androidPlatformNativeInterface = new QAndroidPlatformNativeInterface();
 
+#if QT_CONFIG(egl)
     m_eglDisplay = eglGetDisplay(EGL_DEFAULT_DISPLAY);
     if (Q_UNLIKELY(m_eglDisplay == EGL_NO_DISPLAY))
         qFatal("Could not open egl display");
@@ -185,6 +195,7 @@ QAndroidPlatformIntegration::QAndroidPlatformIntegration(const QStringList &para
 
     if (Q_UNLIKELY(!eglBindAPI(EGL_OPENGL_ES_API)))
         qFatal("Could not bind GL_ES API");
+#endif
 
     using namespace QtJniTypes;
     m_primaryDisplayId = Display::getStaticField<jint>("DEFAULT_DISPLAY");
@@ -347,6 +358,7 @@ QPlatformBackingStore *QAndroidPlatformIntegration::createPlatformBackingStore(Q
     return new QRhiBackingStore(window);
 }
 
+#if QT_CONFIG(egl)
 QPlatformOpenGLContext *QAndroidPlatformIntegration::createPlatformOpenGLContext(QOpenGLContext *context) const
 {
     if (!isValidAndroidContextForRendering())
@@ -389,6 +401,7 @@ QOffscreenSurface *QAndroidPlatformIntegration::createOffscreenSurface(ANativeWi
     surfacePrivate->platformOffscreenSurface = new QAndroidPlatformOffscreenSurface(nativeSurface, m_eglDisplay, surface);
     return surface;
 }
+#endif
 
 QPlatformWindow *QAndroidPlatformIntegration::createPlatformWindow(QWindow *window) const
 {
@@ -400,7 +413,11 @@ QPlatformWindow *QAndroidPlatformIntegration::createPlatformWindow(QWindow *wind
         return new QAndroidPlatformVulkanWindow(window);
 #endif
 
+#if QT_CONFIG(egl)
     return new QAndroidPlatformOpenGLWindow(window, m_eglDisplay);
+#endif
+
+    return nullptr;
 }
 
 QPlatformWindow *QAndroidPlatformIntegration::createForeignWindow(QWindow *window, WId nativeHandle) const
@@ -415,8 +432,10 @@ QAbstractEventDispatcher *QAndroidPlatformIntegration::createEventDispatcher() c
 
 QAndroidPlatformIntegration::~QAndroidPlatformIntegration()
 {
+#if QT_CONFIG(egl)
     if (m_eglDisplay != EGL_NO_DISPLAY)
         eglTerminate(m_eglDisplay);
+#endif
 
     delete m_androidPlatformNativeInterface;
     delete m_androidFDB;
diff --git a/src/plugins/platforms/android/qandroidplatformintegration.h b/src/plugins/platforms/android/qandroidplatformintegration.h
index e050de62540..625429d30b0 100644
--- a/src/plugins/platforms/android/qandroidplatformintegration.h
+++ b/src/plugins/platforms/android/qandroidplatformintegration.h
@@ -40,8 +40,10 @@ protected:
 };
 
 class QAndroidPlatformIntegration : public QPlatformIntegration
+#if QT_CONFIG(egl)
                                   , QNativeInterface::Private::QEGLIntegration
                                   , QNativeInterface::Private::QAndroidOffScreenIntegration
+#endif
 {
     friend class QAndroidPlatformScreen;
 
@@ -56,12 +58,16 @@ public:
     QPlatformWindow *createPlatformWindow(QWindow *window) const override;
     QPlatformWindow *createForeignWindow(QWindow *window, WId nativeHandle) const override;
     QPlatformBackingStore *createPlatformBackingStore(QWindow *window) const override;
+#if QT_CONFIG(egl)
     QPlatformOpenGLContext *createPlatformOpenGLContext(QOpenGLContext *context) const override;
     QOpenGLContext *createOpenGLContext(EGLContext context, EGLDisplay display, QOpenGLContext *shareContext) const override;
+#endif
     QAbstractEventDispatcher *createEventDispatcher() const override;
     QAndroidPlatformScreen *screen() { return m_primaryScreen; }
+#if QT_CONFIG(egl)
     QPlatformOffscreenSurface *createPlatformOffscreenSurface(QOffscreenSurface *surface) const override;
     QOffscreenSurface *createOffscreenSurface(ANativeWindow *nativeSurface) const override;
+#endif
 
     void setAvailableGeometry(const QRect &availableGeometry);
     void setPhysicalSize(int width, int height);
diff --git a/src/plugins/platforms/android/qandroidplatformwindow.cpp b/src/plugins/platforms/android/qandroidplatformwindow.cpp
index 958290fd53d..937839ace0c 100644
--- a/src/plugins/platforms/android/qandroidplatformwindow.cpp
+++ b/src/plugins/platforms/android/qandroidplatformwindow.cpp
@@ -4,7 +4,6 @@
 
 #include "qandroidplatformwindow.h"
 #include "androidbackendregister.h"
-#include "qandroidplatformopenglcontext.h"
 #include "qandroidplatformscreen.h"
 
 #include "androidjnimain.h"
-- 
2.51.2

