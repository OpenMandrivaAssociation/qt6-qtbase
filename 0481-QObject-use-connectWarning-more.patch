From a07157d206cd96a7d2a20b932541a30fdb8ca11a Mon Sep 17 00:00:00 2001
From: Thiago Macieira <thiago.macieira@intel.com>
Date: Fri, 29 Aug 2025 08:53:45 -0700
Subject: [PATCH 481/553] QObject: use connectWarning() more

Drive-by mark it cold, like the other error functions above it.

Pick-to: 6.9 6.8
Change-Id: I2e4b0c0cad3d04ed7597fffd9616301fc736ed2e
Reviewed-by: Ahmad Samir <a.samirh78@gmail.com>
(cherry picked from commit 06c1b4705ebccedcb2007384540826b7ddc03fee)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/corelib/kernel/qobject.cpp                | 37 ++++++++++---------
 .../tst_qmetaobjectbuilder.cpp                |  2 +-
 .../corelib/kernel/qobject/tst_qobject.cpp    |  6 +--
 .../corelib/thread/qfuture/tst_qfuture.cpp    |  2 +-
 4 files changed, 24 insertions(+), 23 deletions(-)

diff --git a/src/corelib/kernel/qobject.cpp b/src/corelib/kernel/qobject.cpp
index 9dcbaac1ed4..3e560bf5b0d 100644
--- a/src/corelib/kernel/qobject.cpp
+++ b/src/corelib/kernel/qobject.cpp
@@ -2633,6 +2633,20 @@ static void err_info_about_objects(const char *func, const QObject *sender, cons
         qCWarning(lcConnect, "QObject::%s:  (receiver name: '%s')", func, b.toLocal8Bit().data());
 }
 
+Q_DECL_COLD_FUNCTION
+static void connectWarning(const QObject *sender,
+                           const QMetaObject *senderMetaObject,
+                           const QObject *receiver,
+                           const char *message)
+{
+    const char *senderString = sender ? sender->metaObject()->className()
+                                      : senderMetaObject ? senderMetaObject->className()
+                                      : "Unknown";
+    const char *receiverString = receiver ? receiver->metaObject()->className()
+                                          : "Unknown";
+    qCWarning(lcConnect, "QObject::connect(%s, %s): %s", senderString, receiverString, message);
+}
+
 /*!
     Returns a pointer to the object that sent the signal, if called in
     a slot activated by a signal; otherwise it returns \nullptr. The pointer
@@ -3999,8 +4013,9 @@ QMetaObject::Connection QMetaObject::connectImpl(const QObject *sender, const QM
 {
     QtPrivate::SlotObjUniquePtr slotObj(slotObjRaw);
 
+    const QMetaObject *senderMetaObject = sender->metaObject();
     if (!signal.isValid() || signal.methodType() != QMetaMethod::Signal) {
-        qCWarning(lcConnect, "QObject::connect: invalid signal parameter");
+        connectWarning(sender, senderMetaObject, receiver, "invalid signal parameter");
         return QMetaObject::Connection();
     }
 
@@ -4010,7 +4025,6 @@ QMetaObject::Connection QMetaObject::connectImpl(const QObject *sender, const QM
         QMetaObjectPrivate::memberIndexes(sender, signal, &signal_index, &dummy);
     }
 
-    const QMetaObject *senderMetaObject = sender->metaObject();
     if (signal_index == -1) {
         qCWarning(lcConnect, "QObject::connect: Can't find signal %s on instance of class %s",
                   signal.methodSignature().constData(), senderMetaObject->className());
@@ -5323,7 +5337,7 @@ QMetaObject::Connection QObject::connectImpl(const QObject *sender, void **signa
 {
     QtPrivate::SlotObjUniquePtr slotObj(slotObjRaw);
     if (!signal) {
-        qCWarning(lcConnect, "QObject::connect: invalid nullptr parameter");
+        connectWarning(sender, senderMetaObject, receiver, "invalid nullptr parameter");
         return QMetaObject::Connection();
     }
 
@@ -5335,26 +5349,13 @@ QMetaObject::Connection QObject::connectImpl(const QObject *sender, void **signa
             break;
     }
     if (!senderMetaObject) {
-        qCWarning(lcConnect, "QObject::connect: signal not found in %s", sender->metaObject()->className());
+        connectWarning(sender, senderMetaObject, receiver, "signal not found");
         return QMetaObject::Connection(nullptr);
     }
     signal_index += QMetaObjectPrivate::signalOffset(senderMetaObject);
     return QObjectPrivate::connectImpl(sender, signal_index, receiver, slot, slotObj.release(), type, types, senderMetaObject);
 }
 
-static void connectWarning(const QObject *sender,
-                           const QMetaObject *senderMetaObject,
-                           const QObject *receiver,
-                           const char *message)
-{
-    const char *senderString = sender ? sender->metaObject()->className()
-                                      : senderMetaObject ? senderMetaObject->className()
-                                      : "Unknown";
-    const char *receiverString = receiver ? receiver->metaObject()->className()
-                                          : "Unknown";
-    qCWarning(lcConnect, "QObject::connect(%s, %s): %s", senderString, receiverString, message);
-}
-
 /*!
     \internal
 
@@ -5573,7 +5574,7 @@ QMetaObject::Connection QObjectPrivate::connect(const QObject *sender, int signa
 {
     QtPrivate::SlotObjUniquePtr slotObj(slotObjRaw);
     if (!sender) {
-        qCWarning(lcConnect, "QObject::connect: invalid nullptr parameter");
+        connectWarning(sender, nullptr, receiver, "invalid nullptr parameter");
         return QMetaObject::Connection();
     }
     const QMetaObject *senderMetaObject = sender->metaObject();
diff --git a/tests/auto/corelib/kernel/qmetaobjectbuilder/tst_qmetaobjectbuilder.cpp b/tests/auto/corelib/kernel/qmetaobjectbuilder/tst_qmetaobjectbuilder.cpp
index 4de1f083406..06fd7307905 100644
--- a/tests/auto/corelib/kernel/qmetaobjectbuilder/tst_qmetaobjectbuilder.cpp
+++ b/tests/auto/corelib/kernel/qmetaobjectbuilder/tst_qmetaobjectbuilder.cpp
@@ -1706,7 +1706,7 @@ void tst_QMetaObjectBuilder::usage_templateConnect()
                                 testObject.data(), &TestObject::voidSlotInt));
 
     // Something that isn't a signal
-    QTest::ignoreMessage(QtWarningMsg, "QObject::connect: signal not found in TestObject");
+    QTest::ignoreMessage(QtWarningMsg, "QObject::connect(TestObject, TestObject): signal not found");
     con = QObject::connect(testObject.data(), &TestObject::setIntProp,
                            testObject.data(), &TestObject::intPropChanged);
     QVERIFY(!con);
diff --git a/tests/auto/corelib/kernel/qobject/tst_qobject.cpp b/tests/auto/corelib/kernel/qobject/tst_qobject.cpp
index 1be228054b8..fb90545b21a 100644
--- a/tests/auto/corelib/kernel/qobject/tst_qobject.cpp
+++ b/tests/auto/corelib/kernel/qobject/tst_qobject.cpp
@@ -4854,18 +4854,18 @@ void tst_QObject::pointerConnect()
     QVERIFY(!QObject::disconnect(con));
 
     //connect a slot to a signal (== error)
-    QTest::ignoreMessage(QtWarningMsg, "QObject::connect: signal not found in ReceiverObject");
+    QTest::ignoreMessage(QtWarningMsg, "QObject::connect(ReceiverObject, SenderObject): signal not found");
     con = connect(&r1, &ReceiverObject::slot4 , &s, &SenderObject::signal4);
     QVERIFY(!con);
     QVERIFY(!QObject::disconnect(con));
 
     //connect an arbitrary PMF to a slot
-    QTest::ignoreMessage(QtWarningMsg, "QObject::connect: signal not found in ReceiverObject");
+    QTest::ignoreMessage(QtWarningMsg, "QObject::connect(ReceiverObject, ReceiverObject): signal not found");
     con = connect(&r1, &ReceiverObject::reset, &r1, &ReceiverObject::slot1);
     QVERIFY(!con);
     QVERIFY(!QObject::disconnect(con));
 
-    QTest::ignoreMessage(QtWarningMsg, "QObject::connect: signal not found in ReceiverObject");
+    QTest::ignoreMessage(QtWarningMsg, "QObject::connect(ReceiverObject, ReceiverObject): signal not found");
     con = connect(&r1, &ReceiverObject::reset, &r1, [](){});
     QVERIFY(!con);
     QVERIFY(!QObject::disconnect(con));
diff --git a/tests/auto/corelib/thread/qfuture/tst_qfuture.cpp b/tests/auto/corelib/thread/qfuture/tst_qfuture.cpp
index 76fcee11b7b..806b6b43161 100644
--- a/tests/auto/corelib/thread/qfuture/tst_qfuture.cpp
+++ b/tests/auto/corelib/thread/qfuture/tst_qfuture.cpp
@@ -3998,7 +3998,7 @@ void tst_QFuture::signalConnect()
 #if defined(Q_CC_MSVC_ONLY) && (Q_CC_MSVC < 1940 || !defined(_DEBUG))
 #define EXPECT_FUTURE_CONNECT_FAIL() QEXPECT_FAIL("", "QTBUG-101761, test fails on Windows/MSVC", Continue)
 #else
-        QTest::ignoreMessage(QtWarningMsg, "QObject::connect: signal not found in SenderObject");
+        QTest::ignoreMessage(QtWarningMsg, "QObject::connect(SenderObject, SenderObject): signal not found");
 #define EXPECT_FUTURE_CONNECT_FAIL()
 #endif
 
-- 
2.51.2

