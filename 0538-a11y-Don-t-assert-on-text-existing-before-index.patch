From ba3f08086d4b6e287d3b0c06887925d9ed118de0 Mon Sep 17 00:00:00 2001
From: Michael Weghorn <m.weghorn@posteo.de>
Date: Tue, 23 Sep 2025 10:40:26 +0200
Subject: [PATCH 538/553] a11y: Don't assert on text existing before index
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

As the QAccessibleTextInterface::textBeforeOffset doc says:

> Returns the text item of type boundaryType that is close to offset
> offset and sets startOffset and endOffset values to the start and end
> positions of that item; returns an empty string if there is no such an
> item. Sets startOffset and endOffset values to -1 on error.

Therefore, return an empty string and set indices to -1
if there is no text item of the given boundary
type before the given index in
QAccessibleTextInterface::textBeforeOffset instead
of asserting, since this is a valid result and this
code path can e.g. get called by platform a11y bridge
implementations like the one for the AT-SPI Text interface's
GetTextBeforeOffset method.

Extend the existing QLineEdit a11y test accordingly.

Fixes: QTBUG-140467
Pick-to: 6.9 6.8
Change-Id: Ibc8d7b4f65ae7787cad8eeebc85b99fd0fb43503
Reviewed-by: Timon Sassor <timon.sassor@governikus.de>
Reviewed-by: Morten Johan SÃ¸rvig <morten.sorvig@qt.io>
(cherry picked from commit 795f1fe3876ed3de1717c9a5c72f823c99189b1b)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/gui/accessible/qaccessible.cpp                     | 7 +++++--
 tests/auto/other/qaccessibility/tst_qaccessibility.cpp | 6 ++++++
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/gui/accessible/qaccessible.cpp b/src/gui/accessible/qaccessible.cpp
index f605ada029c..ce59ca66e6a 100644
--- a/src/gui/accessible/qaccessible.cpp
+++ b/src/gui/accessible/qaccessible.cpp
@@ -2262,13 +2262,16 @@ QString QAccessibleTextInterface::textBeforeOffset(int offset, QAccessible::Text
             break;
     } while (boundary.toPreviousBoundary() > 0);
     Q_ASSERT(boundary.position() >= 0);
-    *endOffset = boundary.position();
+    const int endPos = boundary.position();
 
     while (boundary.toPreviousBoundary() > 0) {
         if ((boundary.boundaryReasons() & (QTextBoundaryFinder::StartOfItem | QTextBoundaryFinder::EndOfItem)))
             break;
     }
-    Q_ASSERT(boundary.position() >= 0);
+    if (boundary.position() < 0)
+        return QString();
+
+    *endOffset = endPos;
     *startOffset = boundary.position();
 
     return txt.mid(*startOffset, *endOffset - *startOffset);
diff --git a/tests/auto/other/qaccessibility/tst_qaccessibility.cpp b/tests/auto/other/qaccessibility/tst_qaccessibility.cpp
index b0c4516f964..30db49e0f08 100644
--- a/tests/auto/other/qaccessibility/tst_qaccessibility.cpp
+++ b/tests/auto/other/qaccessibility/tst_qaccessibility.cpp
@@ -2301,6 +2301,12 @@ void tst_QAccessibility::lineEditTest()
     QCOMPARE(textIface->textAtOffset(5, QAccessible::LineBoundary,&start,&end), cite);
     QCOMPARE(textIface->textAtOffset(5, QAccessible::NoBoundary,&start,&end), cite);
 
+    le3->setText("Hello");
+    QCOMPARE(textIface->textAtOffset(1, QAccessible::WordBoundary, &start, &end),
+             QString::fromLatin1("Hello"));
+    QCOMPARE(textIface->textBeforeOffset(1, QAccessible::WordBoundary, &start, &end), QString());
+    QCOMPARE(textIface->textAfterOffset(1, QAccessible::WordBoundary, &start, &end), QString());
+
     QTestAccessibility::clearEvents();
     }
 
-- 
2.51.2

