From 7748b6733bbbec34a06afbf3fb040e97805e0da8 Mon Sep 17 00:00:00 2001
From: Michael Weghorn <m.weghorn@posteo.de>
Date: Tue, 21 Oct 2025 15:39:23 +0200
Subject: [PATCH 540/553] a11y: Prevent infinite loop in
 QAccessibleTextInterface::textAtOffset
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Detect the case when there is no more boundary
and return an empty string and -1 for the start
and end offset (because no text unit of the wanted
type could be found), instead of looping
infinitely.

Fixes: QTBUG-141388
Task-number: QTBUG-139943
Change-Id: I752ebfc9015e5de74465f03a1b9bb5662abfdc0e
Reviewed-by: Morten Johan SÃ¸rvig <morten.sorvig@qt.io>
(cherry picked from commit 7787698c5c0953b8a8dc0c0739bb3c531d43ef86)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/gui/accessible/qaccessible.cpp | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/gui/accessible/qaccessible.cpp b/src/gui/accessible/qaccessible.cpp
index 6de1dc0d720..d8e1c0bb095 100644
--- a/src/gui/accessible/qaccessible.cpp
+++ b/src/gui/accessible/qaccessible.cpp
@@ -2428,13 +2428,17 @@ QString QAccessibleTextInterface::textAtOffset(int offset, QAccessible::TextBoun
             break;
     } while (boundary.toPreviousBoundary() > 0);
     Q_ASSERT(boundary.position() >= 0);
-    *startOffset = boundary.position();
+    const int startPos = boundary.position();
 
     while (boundary.toNextBoundary() < txt.size()) {
         if ((boundary.boundaryReasons() & (QTextBoundaryFinder::StartOfItem | QTextBoundaryFinder::EndOfItem)))
             break;
+        if (boundary.position() == -1)
+            return QString();
     }
+
     Q_ASSERT(boundary.position() <= txt.size());
+    *startOffset = startPos;
     *endOffset = boundary.position();
 
     return txt.mid(*startOffset, *endOffset - *startOffset);
-- 
2.51.2

