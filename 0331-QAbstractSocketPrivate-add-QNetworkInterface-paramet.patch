From 1319f50a6281ab63f786ab77a3f409d2d28f81d6 Mon Sep 17 00:00:00 2001
From: Ivan Solovev <ivan.solovev@qt.io>
Date: Mon, 22 Sep 2025 11:34:11 +0200
Subject: [PATCH 331/553] QAbstractSocketPrivate: add QNetworkInterface
 parameter to bind()
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

And also export the class, so that it could be accessed from other
modules.
For now, the parameter is unused.

This change is factored out into a separate commit because it touches
SSL-related classes.

Task-number: QTBUG-139697
Task-number: QTBUG-80704
Pick-to: 6.8
Change-Id: I840b2fb57f52779311f9eb09c87a3d6d06c4ef9c
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
(cherry picked from commit 4ce110c50c7c2511626e79ad2d2270537c5ac279)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/network/socket/qabstractsocket.cpp | 5 ++++-
 src/network/socket/qabstractsocket_p.h | 7 +++++--
 src/network/ssl/qsslsocket.cpp         | 4 +++-
 src/network/ssl/qsslsocket_p.h         | 2 +-
 4 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/src/network/socket/qabstractsocket.cpp b/src/network/socket/qabstractsocket.cpp
index dd6d4fea90b..ce3626304c8 100644
--- a/src/network/socket/qabstractsocket.cpp
+++ b/src/network/socket/qabstractsocket.cpp
@@ -1500,10 +1500,13 @@ bool QAbstractSocket::bind(const QHostAddress &address, quint16 port, BindMode m
     return d->bind(address, port, mode);
 }
 
-bool QAbstractSocketPrivate::bind(const QHostAddress &address, quint16 port, QAbstractSocket::BindMode mode)
+bool QAbstractSocketPrivate::bind(const QHostAddress &address, quint16 port, QAbstractSocket::BindMode mode,
+                                  const QNetworkInterface *iface)
 {
     Q_Q(QAbstractSocket);
 
+    Q_UNUSED(iface); // will be used in a follow-up patch
+
     // now check if the socket engine is initialized and to the right type
     if (!socketEngine || !socketEngine->isValid()) {
         QHostAddress nullAddress;
diff --git a/src/network/socket/qabstractsocket_p.h b/src/network/socket/qabstractsocket_p.h
index 1ffe4f197a7..3100802d4ab 100644
--- a/src/network/socket/qabstractsocket_p.h
+++ b/src/network/socket/qabstractsocket_p.h
@@ -28,8 +28,10 @@
 QT_BEGIN_NAMESPACE
 
 class QHostInfo;
+class QNetworkInterface;
 
-class QAbstractSocketPrivate : public QIODevicePrivate, public QAbstractSocketEngineReceiver
+class Q_NETWORK_EXPORT QAbstractSocketPrivate : public QIODevicePrivate,
+                                                public QAbstractSocketEngineReceiver
 {
     Q_DECLARE_PUBLIC(QAbstractSocket)
 public:
@@ -49,7 +51,8 @@ public:
     }
 #endif
 
-    virtual bool bind(const QHostAddress &address, quint16 port, QAbstractSocket::BindMode mode);
+    virtual bool bind(const QHostAddress &address, quint16 port, QAbstractSocket::BindMode mode,
+                      const QNetworkInterface *iface = nullptr);
 
     virtual bool canReadNotification();
     bool canWriteNotification();
diff --git a/src/network/ssl/qsslsocket.cpp b/src/network/ssl/qsslsocket.cpp
index b3be3490d8e..93123b6553b 100644
--- a/src/network/ssl/qsslsocket.cpp
+++ b/src/network/ssl/qsslsocket.cpp
@@ -2423,8 +2423,10 @@ void QSslSocketPrivate::setPaused(bool p)
     paused = p;
 }
 
-bool QSslSocketPrivate::bind(const QHostAddress &address, quint16 port, QAbstractSocket::BindMode mode)
+bool QSslSocketPrivate::bind(const QHostAddress &address, quint16 port, QAbstractSocket::BindMode mode,
+                             const QNetworkInterface *iface)
 {
+    Q_UNUSED(iface); // only relevant for QUdpSocket for now
     // this function is called from QAbstractSocket::bind
     if (!initialized)
         init();
diff --git a/src/network/ssl/qsslsocket_p.h b/src/network/ssl/qsslsocket_p.h
index 563851b191f..fb8da65dac1 100644
--- a/src/network/ssl/qsslsocket_p.h
+++ b/src/network/ssl/qsslsocket_p.h
@@ -99,7 +99,7 @@ public:
     static std::shared_ptr<QSslContext> sslContext(QSslSocket *socket);
     bool isPaused() const;
     void setPaused(bool p);
-    bool bind(const QHostAddress &address, quint16, QAbstractSocket::BindMode) override;
+    bool bind(const QHostAddress &address, quint16, QAbstractSocket::BindMode, const QNetworkInterface *iface = nullptr) override;
     void _q_connectedSlot();
     void _q_hostFoundSlot();
     void _q_disconnectedSlot();
-- 
2.51.2

