From ffb1c0ad38086db8586ef9115ec62e9ac49aceb6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Tor=20Arne=20Vestb=C3=B8?= <tor.arne.vestbo@qt.io>
Date: Thu, 28 Aug 2025 21:02:35 +0200
Subject: [PATCH 029/553] QImageWriter: Don't load handlers from plugins if we
 found a built-in one
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

We never hit this case before, because all of our image handlers
declared their supported formats statically, but we can potentially
end up in this situation for handlers that report support for formats
that they have not declared.

The delete of handler in the loop was added because Valgrind was
complaining -- not because we actually supported or wanted plugins
to override the built in handlers unless they explicitly declared
they supported the format.

Pick-to: 6.9 6.8
Change-Id: If38f76345f71d419598b7834c83bbd5d07f757e1
Reviewed-by: Eirik Aavitsland <eirik.aavitsland@qt.io>
(cherry picked from commit 5ff53d09e89b68ded7ab22b357563da1480d935a)
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
---
 src/gui/image/qimagewriter.cpp | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/gui/image/qimagewriter.cpp b/src/gui/image/qimagewriter.cpp
index e63876d1962..d1af269f257 100644
--- a/src/gui/image/qimagewriter.cpp
+++ b/src/gui/image/qimagewriter.cpp
@@ -176,12 +176,11 @@ static QImageIOHandler *createWriteHandlerHelper(QIODevice *device,
     }
 
 #ifndef QT_NO_IMAGEFORMATPLUGIN
-    if (!testFormat.isEmpty()) {
+    if (!handler && !testFormat.isEmpty()) {
         const int keyCount = keyMap.size();
         for (int i = 0; i < keyCount; ++i) {
             QImageIOPlugin *plugin = qobject_cast<QImageIOPlugin *>(l->instance(i));
             if (plugin && (plugin->capabilities(device, testFormat) & QImageIOPlugin::CanWrite)) {
-                delete handler;
                 handler = plugin->create(device, testFormat);
                 break;
             }
-- 
2.51.2

