From 549a536d6d87f142dd169c45adec01e84943ea38 Mon Sep 17 00:00:00 2001
From: Assam Boudjelthia <assam.boudjelthia@qt.io>
Date: Tue, 16 Sep 2025 17:43:20 +0300
Subject: [PATCH 234/553] Android: change only the opacity of system bars when
 setting system ui
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

When switching between expanded mode (similar to edge-to-edge) and
back to normal mode, we shouldn't be touching the colors of the
system bars, as that can mess up with the theme values or user
defined values. Instead, simply change the opacity (alpha bits)
of the color so we get transparent bars in expanded mode and
opaque bars in normal mode.

Task-number: QTBUG-139690
Pick-to: 6.8
Change-Id: Iadc5a9d8625c50009a0dc1a5ac29b5354089d345
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit d59bd61d8e7aa11598853a422498239b6a1d6b6f)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../qt/android/QtDisplayManager.java          | 39 +++++++++++++++++--
 1 file changed, 36 insertions(+), 3 deletions(-)

diff --git a/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java b/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java
index 3cd26dffb12..7c6f91c3314 100644
--- a/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java
+++ b/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java
@@ -7,6 +7,7 @@ import android.app.Activity;
 import android.content.Context;
 import android.content.res.Configuration;
 import android.content.res.Resources;
+import android.content.res.TypedArray;
 import android.graphics.Rect;
 import android.hardware.display.DisplayManager;
 import android.os.Build;
@@ -195,11 +196,29 @@ class QtDisplayManager
             setSystemUiVisibilityPreAndroidR(decorView);
         }
 
-        if (!isFullScreen) {
+        if (!isFullScreen && !edgeToEdgeEnabled(m_activity)) {
+            // These are needed to operate on system bar colors
+            window.clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS
+                        | WindowManager.LayoutParams.FLAG_TRANSLUCENT_NAVIGATION);
+            window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
+
             // Handle transparent status and navigation bars
             if (m_expandedToCutout) {
-                window.setStatusBarColor(Color.TRANSPARENT);
-                window.setNavigationBarColor(Color.TRANSPARENT);
+                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
+                    window.setStatusBarColor(Color.TRANSPARENT);
+                    window.setNavigationBarColor(Color.TRANSPARENT);
+                } else {
+                    // Android 9 and prior doesn't add the semi-transparent bars
+                    // to avoid low contrast system icons, so try to mimick it
+                    // by taking the current color and only increase the opacity.
+                    int statusBarColor = window.getStatusBarColor();
+                    int transparentStatusBar = statusBarColor & 0x00FFFFFF;
+                    window.setStatusBarColor(transparentStatusBar);
+
+                    int navigationBarColor = window.getNavigationBarColor();
+                    int semiTransparentNavigationBar = navigationBarColor & 0x7FFFFFFF;
+                    window.setNavigationBarColor(semiTransparentNavigationBar);
+                }
             } else {
                 // Restore theme's system bars colors
                 Theme theme = m_activity.getTheme();
@@ -218,6 +237,20 @@ class QtDisplayManager
         decorView.post(() -> decorView.requestApplyInsets());
     }
 
+    private static boolean edgeToEdgeEnabled(Activity activity) {
+        if (Build.VERSION.SDK_INT > Build.VERSION_CODES.VANILLA_ICE_CREAM)
+            return true;
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.VANILLA_ICE_CREAM)
+            return false;
+        int[] attrs = new int[] { android.R.attr.windowOptOutEdgeToEdgeEnforcement };
+        TypedArray ta = activity.getTheme().obtainStyledAttributes(attrs);
+        try {
+            return !ta.getBoolean(0, false);
+        } finally {
+            ta.recycle();
+        }
+    }
+
     boolean isFullScreen()
     {
         return m_isFullScreen;
-- 
2.51.2

