From 8689f232ac483bed5593a0d8ea68716ba6374a36 Mon Sep 17 00:00:00 2001
From: Samuli Piippo <samuli.piippo@qt.io>
Date: Thu, 25 Sep 2025 13:49:18 +0300
Subject: [PATCH 231/553] QNetworkInfo[glib]: better support for netlink
 backend
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Glib's GNetworkMonitor has a netlink backend which does not emit
`notify::connectivity` signals. Add monitoring for `network-changed`
signal, which will enable glib plugin to get updates on embedded
device that don't use networkmanager.

Change-Id: I795f955361111ff8eafdddc3cb9d9e2310d26509
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
(cherry picked from commit f43d8ad3dff9aa37530d160ed1de49f765e21a6c)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../glib/qglibnetworkinformationbackend.cpp                  | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/plugins/networkinformation/glib/qglibnetworkinformationbackend.cpp b/src/plugins/networkinformation/glib/qglibnetworkinformationbackend.cpp
index 1e6bb197125..62d24eefd33 100644
--- a/src/plugins/networkinformation/glib/qglibnetworkinformationbackend.cpp
+++ b/src/plugins/networkinformation/glib/qglibnetworkinformationbackend.cpp
@@ -70,6 +70,7 @@ private:
 
     GNetworkMonitor *networkMonitor = nullptr;
     gulong connectivityHandlerId = 0;
+    gulong networkHandlerId = 0;
     gulong meteredHandlerId = 0;
 };
 
@@ -109,6 +110,9 @@ QGlibNetworkInformationBackend::QGlibNetworkInformationBackend()
     connectivityHandlerId = g_signal_connect_swapped(networkMonitor, "notify::connectivity",
                                                      G_CALLBACK(updateConnectivity), this);
 
+    networkHandlerId = g_signal_connect_swapped(networkMonitor, "network-changed",
+                                                     G_CALLBACK(updateConnectivity), this);
+
     meteredHandlerId = g_signal_connect_swapped(networkMonitor, "notify::network-metered",
                                                 G_CALLBACK(updateMetered), this);
 }
@@ -116,6 +120,7 @@ QGlibNetworkInformationBackend::QGlibNetworkInformationBackend()
 QGlibNetworkInformationBackend::~QGlibNetworkInformationBackend()
 {
     g_signal_handler_disconnect(networkMonitor, meteredHandlerId);
+    g_signal_handler_disconnect(networkMonitor, networkHandlerId);
     g_signal_handler_disconnect(networkMonitor, connectivityHandlerId);
 }
 
-- 
2.51.2

