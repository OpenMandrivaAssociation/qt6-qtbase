From 63345a96fa7606c1eb69378935a3374a239ca70f Mon Sep 17 00:00:00 2001
From: Tim Blechmann <tim.blechmann@qt.io>
Date: Tue, 7 Oct 2025 11:49:40 +0800
Subject: [PATCH 341/553] QWindowsWindow: requestUpdate - fix use-after-free
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

QMetaObject::invokeMethod can overtake the destruction of the
QWindowsWindow. So instread of storing the `this` pointer in the lambda
capture we explicitly re-read it from the QWindow. This should fix a
heap-use-after-free reported by address sanitizer.

Amends 456fb97ddc4c606999c5468e063fe1c6f59c4408

Fixes: QTBUG-140869
Change-Id: I47805c606fa32b6f370e0214829f2ea3e9bce83d
Reviewed-by: Christian Str√∏mme <christian.stromme@qt.io>
(cherry picked from commit 31c38d5f766366931cd127f7323f9c26ac5de498)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/plugins/platforms/windows/qwindowswindow.cpp | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/src/plugins/platforms/windows/qwindowswindow.cpp b/src/plugins/platforms/windows/qwindowswindow.cpp
index 8d821cc5fdf..907cb388140 100644
--- a/src/plugins/platforms/windows/qwindowswindow.cpp
+++ b/src/plugins/platforms/windows/qwindowswindow.cpp
@@ -4024,10 +4024,13 @@ void QWindowsWindow::requestUpdate()
                     // request or we are waiting for the event loop to process
                     // the Posted event on the GUI thread.
                     if (m_vsyncUpdatePending.testAndSetAcquire(UpdateState::Requested, UpdateState::Posted)) {
-                        QMetaObject::invokeMethod(w, [this, w] {
-                            m_vsyncUpdatePending.storeRelease(UpdateState::Ready);
-                            if (w->handle() == this)
-                                deliverUpdateRequest();
+                        QMetaObject::invokeMethod(w, [w] {
+                            auto *self = static_cast<QWindowsWindow *>(w->handle());
+                            if (self) {
+                                // The platform window is still alive
+                                self->m_vsyncUpdatePending.storeRelease(UpdateState::Ready);
+                                self->deliverUpdateRequest();
+                            }
                         });
                     }
                 }
-- 
2.51.2

