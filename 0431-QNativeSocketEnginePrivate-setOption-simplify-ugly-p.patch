From 49ef0d7b26b6d1d6141eff9c19708bb3fff9d887 Mon Sep 17 00:00:00 2001
From: Thiago Macieira <thiago.macieira@intel.com>
Date: Thu, 16 Oct 2025 09:47:21 -0700
Subject: [PATCH 431/553] QNativeSocketEnginePrivate::setOption: simplify ugly
 perror() handling
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

With a macro.

Drive-by clean up the VxWorks implementation of NonBlockingSocketOption,
as we know v == 1 on input.

Pick-to: 6.9 6.8
Change-Id: I917f5f39ded2fa338803fffd91002fca28d7faaa
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
(cherry picked from commit b3a6d0e28487baa1678bca2098b1e1108f9be6e0)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../socket/qnativesocketengine_unix.cpp       | 23 ++++++++-----------
 1 file changed, 10 insertions(+), 13 deletions(-)

diff --git a/src/network/socket/qnativesocketengine_unix.cpp b/src/network/socket/qnativesocketengine_unix.cpp
index 7c26c31276a..b5481ede6cb 100644
--- a/src/network/socket/qnativesocketengine_unix.cpp
+++ b/src/network/socket/qnativesocketengine_unix.cpp
@@ -326,6 +326,11 @@ int QNativeSocketEnginePrivate::option(QNativeSocketEngine::SocketOption opt) co
 */
 bool QNativeSocketEnginePrivate::setOption(QNativeSocketEngine::SocketOption opt, int v)
 {
+#ifdef QNATIVESOCKETENGINE_DEBUG
+#  define perrorDebug(msg)  perror("QNativeSocketEnginePrivate::setOption(): " msg)
+#else
+#  define perrorDebug(msg)  (void)0
+#endif
     Q_Q(QNativeSocketEngine);
     if (!q->isValid())
         return false;
@@ -337,25 +342,16 @@ bool QNativeSocketEnginePrivate::setOption(QNativeSocketEngine::SocketOption opt
 #if !defined(Q_OS_VXWORKS)
         int flags = ::fcntl(socketDescriptor, F_GETFL, 0);
         if (flags == -1) {
-#ifdef QNATIVESOCKETENGINE_DEBUG
-            perror("QNativeSocketEnginePrivate::setOption(): fcntl(F_GETFL) failed");
-#endif
+            perrorDebug("fcntl(F_GETFL) failed");
             return false;
         }
         if (::fcntl(socketDescriptor, F_SETFL, flags | O_NONBLOCK) == -1) {
-#ifdef QNATIVESOCKETENGINE_DEBUG
-            perror("QNativeSocketEnginePrivate::setOption(): fcntl(F_SETFL) failed");
-#endif
+            perrorDebug("fcntl(F_SETFL) failed");
             return false;
         }
 #else // Q_OS_VXWORKS
-        int onoff = 1;
-
-        if (qt_safe_ioctl(socketDescriptor, FIONBIO, &onoff) < 0) {
-
-#ifdef QNATIVESOCKETENGINE_DEBUG
-            perror("QNativeSocketEnginePrivate::setOption(): ioctl(FIONBIO, 1) failed");
-#endif
+        if (qt_safe_ioctl(socketDescriptor, FIONBIO, &v) < 0) {
+            perrorDebug("ioctl(FIONBIO, 1) failed");
             return false;
         }
 #endif // Q_OS_VXWORKS
@@ -417,6 +413,7 @@ bool QNativeSocketEnginePrivate::setOption(QNativeSocketEngine::SocketOption opt
     if (n == -1)
         return false;
     return ::setsockopt(socketDescriptor, level, n, (char *) &v, sizeof(v)) == 0;
+#undef perrorDebug
 }
 
 bool QNativeSocketEnginePrivate::nativeConnect(const QHostAddress &addr, quint16 port)
-- 
2.51.2

