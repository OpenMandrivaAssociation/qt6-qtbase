From 80de173ef0e45f7f63c5a2c30626adec9f06126c Mon Sep 17 00:00:00 2001
From: Tim Blechmann <tim.blechmann@qt.io>
Date: Fri, 3 Oct 2025 12:38:02 +0800
Subject: [PATCH 448/553] Testlib: disable App Nap for whole execution of the
 test
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The intention was to disable App Nap for the whole test. However it was
a RAII class which was destroyed at the end of QTest::qInit. This patch
moves the AppNap disabler into a global variable, which is cleared in
qCleanup.

Pick-to: 6.8
Change-Id: I5c267b2b66626b230851e61e79655ef3a30d4481
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit 305e1ba820ff02d8aa46e902634590c307c21f17)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/testlib/qtestcase.cpp | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/testlib/qtestcase.cpp b/src/testlib/qtestcase.cpp
index 5288998d2a5..f82beedee7f 100644
--- a/src/testlib/qtestcase.cpp
+++ b/src/testlib/qtestcase.cpp
@@ -393,6 +393,7 @@ static QString mainSourcePath;
 static bool inTestFunction = false;
 
 #if defined(Q_OS_MACOS)
+static std::optional<QTestPrivate::AppNapDisabler> appNapDisabler;
 static IOPMAssertionID macPowerSavingDisabled = 0;
 #endif
 
@@ -1881,7 +1882,8 @@ void QTest::qInit(QObject *testObject, int argc, char **argv)
     QTestPrivate::disableWindowRestore();
 
     // Disable App Nap which may cause tests to stall
-    QTestPrivate::AppNapDisabler appNapDisabler;
+    if (!appNapDisabler)
+        appNapDisabler.emplace();
 
     if (qApp && (qstrcmp(qApp->metaObject()->className(), "QApplication") == 0)) {
         IOPMAssertionCreateWithName(kIOPMAssertionTypeNoDisplaySleep,
@@ -2041,6 +2043,7 @@ void QTest::qCleanup()
 
 #if defined(Q_OS_MACOS)
     IOPMAssertionRelease(macPowerSavingDisabled);
+    appNapDisabler = std::nullopt;
 #endif
 }
 
-- 
2.51.2

