From e935d92fc39b53867cf8810e1890932ae4a8d81f Mon Sep 17 00:00:00 2001
From: Igor Khanin <igor@khanin.biz>
Date: Wed, 24 Sep 2025 22:08:37 +0300
Subject: [PATCH 212/553] QMacStyle: Draw disclosure triangles according to
 correct direction
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

When using a QTreeView and overriding its' (or any ancestor widget's)
layout direction from the default, on the Mac style the indicator
branches would be rendered pointing the wrong way - as those are drawn
as native disclosure triangle buttons whose NSCell did not get the
proper layout direction passed on to. This fixes it.

Pick-to: 6.9 6.8
Change-Id: Ic708e82dd2534af674822fa2432ce4a4af22c522
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit 4caaa435ca1ee94e7042b8ae6f7023035b977c5c)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/plugins/styles/mac/qmacstyle_mac.mm | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/src/plugins/styles/mac/qmacstyle_mac.mm b/src/plugins/styles/mac/qmacstyle_mac.mm
index 46f195fcd6c..de8ebbeebf5 100644
--- a/src/plugins/styles/mac/qmacstyle_mac.mm
+++ b/src/plugins/styles/mac/qmacstyle_mac.mm
@@ -769,6 +769,18 @@ static bool qt_macWindowMainWindow(const QWidget *window)
     return false;
 }
 
+static NSUserInterfaceLayoutDirection qt_macLayoutDirectionFromQt(Qt::LayoutDirection direction)
+{
+    switch (direction) {
+    case Qt::LeftToRight:
+        return NSUserInterfaceLayoutDirectionLeftToRight;
+    case Qt::RightToLeft:
+        return NSUserInterfaceLayoutDirectionRightToLeft;
+    case Qt::LayoutDirectionAuto:
+        return [NSApp userInterfaceLayoutDirection];
+    }
+}
+
 /*****************************************************************************
   QMacCGStyle globals
  *****************************************************************************/
@@ -3510,6 +3522,7 @@ void QMacStyle::drawPrimitive(PrimitiveElement pe, const QStyleOption *opt, QPai
         [triangleCell setState:(opt->state & State_Open) ? NSControlStateValueOn : NSControlStateValueOff];
         bool viewHasFocus = (w && w->hasFocus()) || (opt->state & State_HasFocus);
         [triangleCell setBackgroundStyle:((opt->state & State_Selected) && viewHasFocus) ? NSBackgroundStyleEmphasized : NSBackgroundStyleNormal];
+        [triangleCell setUserInterfaceLayoutDirection:qt_macLayoutDirectionFromQt(opt->direction)];
 
         d->setupNSGraphicsContext(cg, NO);
 
-- 
2.51.2

