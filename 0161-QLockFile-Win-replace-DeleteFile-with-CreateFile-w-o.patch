From 0b6863d83ec9ec6813bdca0fe301a7e7c4c1873d Mon Sep 17 00:00:00 2001
From: Thiago Macieira <thiago.macieira@intel.com>
Date: Tue, 16 Sep 2025 16:46:22 -0700
Subject: [PATCH 161/553] QLockFile/Win: replace DeleteFile with CreateFile w/o
 sharing
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

What looks like an antithetical change actually makes sense: we open the
file with FILE_FLAG_DELETE_ON_CLOSE, which causes the file to be deleted
when we CloseHandle(). In fact, this is exactly how wine implements
DeleteFile[1].

The difference between this and DeleteFile itself is that we are opening
the file for writing but not allowing any sharing. This means no other
process in the system can open the file at the same time as we do, even
if they want to cooperate in deleting it.

[1] https://github.com/wine-mirror/wine/blob/wine-10.15/dlls/kernelbase/file.c#L1011

Fixes: QTBUG-140053
Pick-to: 6.9 6.8
Change-Id: Iba265eba236f496ce5c9fffdc5daf95d5f429358
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
(cherry picked from commit 49042a61d85c14cf89faf7ce61f64a6c36f8f084)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/corelib/io/qlockfile_win.cpp | 20 +++++++++++++++++++-
 1 file changed, 19 insertions(+), 1 deletion(-)

diff --git a/src/corelib/io/qlockfile_win.cpp b/src/corelib/io/qlockfile_win.cpp
index 472802d9d92..12a668def0f 100644
--- a/src/corelib/io/qlockfile_win.cpp
+++ b/src/corelib/io/qlockfile_win.cpp
@@ -27,7 +27,25 @@ static inline bool fileExists(const wchar_t *fileName)
 
 static bool deleteFile(const QString &fileName)
 {
-    return DeleteFile(qt_castToWchar(QDir::toNativeSeparators(fileName)));
+    const DWORD dwShareMode = 0;    // no sharing
+    SECURITY_ATTRIBUTES securityAtts = { sizeof(SECURITY_ATTRIBUTES), NULL, FALSE };
+    HANDLE fh = CreateFile(qt_castToWchar(QDir::toNativeSeparators(fileName)),
+                           GENERIC_READ | GENERIC_WRITE,
+                           dwShareMode,
+                           &securityAtts,
+                           OPEN_EXISTING, // error if it doesn't exist
+                           FILE_ATTRIBUTE_NORMAL | FILE_FLAG_DELETE_ON_CLOSE,
+                           NULL);
+    bool success = (fh != INVALID_HANDLE_VALUE);
+    if (success) {
+        CloseHandle(fh);
+        // the file is now deleted
+    } else {
+        const DWORD lastError = GetLastError();
+        if (lastError == ERROR_FILE_NOT_FOUND)
+            success = true;
+    }
+    return success;
 }
 
 QLockFile::LockError QLockFilePrivate::tryLock_sys()
-- 
2.51.2

