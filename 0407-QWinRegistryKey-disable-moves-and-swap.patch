From 282c74813ce9dd449576a6e9ebb9f40ab5238dde Mon Sep 17 00:00:00 2001
From: Marc Mutz <marc.mutz@qt.io>
Date: Tue, 30 Sep 2025 12:27:37 +0200
Subject: [PATCH 407/553] QWinRegistryKey: disable moves and swap()
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Since 589bfddc7c44a92e7e3f98a1e73871793c153ab7, the class is-a QObject
and has a new data member, m_keyChangedEvent. Neither swap() nor the
move SMFs handle the new member, and it's unclear how they should
handle it, seeing it is tied to both m_key and the QObject identity of
its enclosing class, the latter of which cannot be moved or swapped.

De-QObject-ify'ing the class again (QTBUG-140671) would allow to
define the semantics of subsribing to valueChanged() notifications
vis-a-vis move semantics. Until then, and as a hot-fix, disable the
move SMFs and swap().

Task-number: QTBUG-140725
Change-Id: I9cecbe2afb98e5caa6889c2591fdd6a59106dab3
Reviewed-by: Oliver Wolff <oliver.wolff@qt.io>
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit 24735a41ceefa0aff0d3843869e0ac580e760ba9)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/corelib/kernel/qwinregistry_p.h | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/corelib/kernel/qwinregistry_p.h b/src/corelib/kernel/qwinregistry_p.h
index e8b749a5653..fd6d6dc853f 100644
--- a/src/corelib/kernel/qwinregistry_p.h
+++ b/src/corelib/kernel/qwinregistry_p.h
@@ -42,12 +42,17 @@ public:
     ~QWinRegistryKey();
 
     QWinRegistryKey(QWinRegistryKey &&other) noexcept
+#if 1 // QTBUG-140725
+        = delete;
+    void operator=(QWinRegistryKey &&) = delete;
+#else
         : m_key(std::exchange(other.m_key, nullptr)) {}
     QT_MOVE_ASSIGNMENT_OPERATOR_IMPL_VIA_MOVE_AND_SWAP(QWinRegistryKey)
     void swap(QWinRegistryKey &other) noexcept
     {
         qt_ptr_swap(m_key, other.m_key);
     }
+#endif
 
     [[nodiscard]] bool isValid() const { return m_key != nullptr; }
 
-- 
2.51.2

