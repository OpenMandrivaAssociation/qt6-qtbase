From 8cd871c759efea2a95016ab50352694888f66990 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Morten=20S=C3=B8rvig?= <morten.sorvig@qt.io>
Date: Thu, 18 Sep 2025 22:23:45 +0200
Subject: [PATCH 211/553] wasm: fix memory corruption in Promise handling
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The "finally" handler deregisters and deletes itself, but
would do so before it was completed. Move the removeEventHandler()
call to the end of the lambda function.

As it happens this did not cause any issues on wasm32,
but for wasm64 finallyFunc would become corrupted and
crash with an "null function or function signature mismatch"
error.

Change-Id: I66125190677843593866b8eec950ac60d2bb75ce
(cherry picked from commit 5feade6a729b58f7958424947ad4ed20c2fccfa1)
Reviewed-by: Morten Johan SÃ¸rvig <morten.sorvig@qt.io>
---
 src/corelib/platform/wasm/qstdweb.cpp | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/corelib/platform/wasm/qstdweb.cpp b/src/corelib/platform/wasm/qstdweb.cpp
index e8ac66464b2..badb6a73cc6 100644
--- a/src/corelib/platform/wasm/qstdweb.cpp
+++ b/src/corelib/platform/wasm/qstdweb.cpp
@@ -477,11 +477,13 @@ void Promise::adoptPromise(emscripten::val promise, PromiseCallbacks callbacks)
             suspendResume->removeEventHandler(*thenIndex);
         if (catchIndex)
             suspendResume->removeEventHandler(*catchIndex);
-        suspendResume->removeEventHandler(*finallyIndex);
 
         // Call user finally
         if (finallyFunc)
             finallyFunc();
+
+        // Remove the finally (this) event handler last
+        suspendResume->removeEventHandler(*finallyIndex);
     };
 
     *finallyIndex = suspendResume->registerEventHandler(std::move(finally));
-- 
2.51.2

