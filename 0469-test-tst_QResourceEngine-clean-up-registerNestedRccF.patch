From 085208ea42f24b29b7c17a2d07e831721fea6502 Mon Sep 17 00:00:00 2001
From: Tim Blechmann <tim.blechmann@qt.io>
Date: Thu, 23 Oct 2025 12:46:09 +0800
Subject: [PATCH 469/553] test: tst_QResourceEngine - clean up
 registerNestedRccFile
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

registerNestedRccFile did not clean up after itself, causing failures in
repeated invocations.
The string for a duplicate QResource::registerResource call was also,
wrong, as multiple calls for the same resource are allowed (and in fact
refcounted). Extending the test to unregister will fix -repeat and
validates the resource unregistration.

Change-Id: I53df8174e099777888453f58cb1c94288cba0646
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit ff4a289ff6adb874b68635568db5a0964f59ba55)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../io/qresourceengine/tst_qresourceengine.cpp     | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/tests/auto/corelib/io/qresourceengine/tst_qresourceengine.cpp b/tests/auto/corelib/io/qresourceengine/tst_qresourceengine.cpp
index 472e03adcac..00672ef0b6a 100644
--- a/tests/auto/corelib/io/qresourceengine/tst_qresourceengine.cpp
+++ b/tests/auto/corelib/io/qresourceengine/tst_qresourceengine.cpp
@@ -678,8 +678,20 @@ void tst_QResourceEngine::registerNestedRccFile()
                                         "/registeredNestedRccFile"));
     QVERIFY2(QResource::registerResource(":/nestedrcc/runtime_resource.rcc",
                                          "/registeredNestedRccFile"),
-             "Second QResource::registerResource call failed.");
+             "Second QResource::registerResource call does not failed.");
     QVERIFY(QFile::exists(":/registeredNestedRccFile/runtime_resource/search_file.txt"));
+
+    // clean up
+    QVERIFY(QResource::unregisterResource(":/nestedrcc/runtime_resource.rcc",
+                                          "/registeredNestedRccFile"));
+
+    QVERIFY(QFile::exists(":/registeredNestedRccFile/runtime_resource/search_file.txt"));
+
+    QVERIFY(QResource::unregisterResource(":/nestedrcc/runtime_resource.rcc",
+                                          "/registeredNestedRccFile"));
+
+    // verify clean up
+    QVERIFY(!QFile::exists(":/registeredNestedRccFile/runtime_resource/search_file.txt"));
 }
 
 QTEST_MAIN(tst_QResourceEngine)
-- 
2.51.2

