From 3e8f91b3243ce6551c8584fe0bd969b2fdbfa454 Mon Sep 17 00:00:00 2001
From: Assam Boudjelthia <assam.boudjelthia@qt.io>
Date: Wed, 17 Sep 2025 05:07:50 +0300
Subject: [PATCH 236/553] Android: read and apply theme's values on
 handUiModeChange
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

When the uiMode changes like from light to dark mode, to keep the bars
contrast correct we need to re-apply the theme's colors again, otherwise
the system won't do it for us because we explicitly opted in to handle
any uiMode change ourselves.

Task-number: QTBUG-137248
Pick-to: 6.8
Change-Id: I5f918fe047077c5a12be08b0baefb58cf08b5106
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
(cherry picked from commit 8a7759a5f90cd8ed8ad510c2370c99e2c36b219c)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../qt/android/QtActivityDelegateBase.java    |  27 ++--
 .../qt/android/QtDisplayManager.java          | 124 ++++++++++++++++++
 2 files changed, 139 insertions(+), 12 deletions(-)

diff --git a/src/android/jar/src/org/qtproject/qt/android/QtActivityDelegateBase.java b/src/android/jar/src/org/qtproject/qt/android/QtActivityDelegateBase.java
index 1c5cad8d904..fe36981a84c 100644
--- a/src/android/jar/src/org/qtproject/qt/android/QtActivityDelegateBase.java
+++ b/src/android/jar/src/org/qtproject/qt/android/QtActivityDelegateBase.java
@@ -9,6 +9,7 @@ import android.app.Activity;
 import android.content.pm.ActivityInfo;
 import android.content.pm.PackageManager;
 import android.content.res.Configuration;
+import android.content.res.Resources;
 import android.graphics.Color;
 import android.os.Build;
 import android.view.Window;
@@ -96,21 +97,23 @@ abstract class QtActivityDelegateBase
 
     void handleUiModeChange()
     {
-        Configuration config = m_activity.getResources().getConfiguration();
+        Resources resources = m_activity.getResources();
+        Configuration config = resources.getConfiguration();
         int uiMode = config.uiMode & Configuration.UI_MODE_NIGHT_MASK;
-        // QTBUG-108365
-        if (Build.VERSION.SDK_INT >= 30) {
-            // Since 29 version we are using Theme_DeviceDefault_DayNight
+
+        if (m_displayManager.decorFitsSystemWindows()) {
             Window window = m_activity.getWindow();
-            WindowInsetsController controller = window.getInsetsController();
-            if (controller != null) {
-                // set APPEARANCE_LIGHT_STATUS_BARS if needed
-                int appearanceLight = Color.luminance(window.getStatusBarColor()) > 0.5 ?
-                        WindowInsetsController.APPEARANCE_LIGHT_STATUS_BARS : 0;
-                controller.setSystemBarsAppearance(appearanceLight,
-                    WindowInsetsController.APPEARANCE_LIGHT_STATUS_BARS);
-            }
+            QtDisplayManager.enableSystemBarsBackgroundDrawing(window);
+            int status = QtDisplayManager.getThemeDefaultStatusBarColor(m_activity);
+            QtDisplayManager.setStatusBarColor(window, status);
+            int nav = QtDisplayManager.getThemeDefaultNavigationBarColor(m_activity);
+            QtDisplayManager.setNavigationBarColor(window, nav);
         }
+
+        boolean isLight = uiMode == Configuration.UI_MODE_NIGHT_NO;
+        QtDisplayManager.setStatusBarColorHint(m_activity, isLight);
+        QtDisplayManager.setNavigationBarColorHint(m_activity, isLight);
+
         switch (uiMode) {
             case Configuration.UI_MODE_NIGHT_NO:
                 ExtractStyle.runIfNeeded(m_activity, false);
diff --git a/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java b/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java
index 7c6f91c3314..8736dfab771 100644
--- a/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java
+++ b/src/android/jar/src/org/qtproject/qt/android/QtDisplayManager.java
@@ -261,6 +261,11 @@ class QtDisplayManager
         return m_expandedToCutout;
     }
 
+    boolean decorFitsSystemWindows()
+    {
+        return !isFullScreen() && !expandedToCutout();
+    }
+
     void reinstateFullScreen()
     {
         if (m_isFullScreen) {
@@ -269,6 +274,125 @@ class QtDisplayManager
         }
     }
 
+    /*
+    * Convenience method to call deprecated API prior to Android R (30).
+    */
+    @SuppressWarnings ("deprecation")
+    private static void setSystemUiVisibility(View decorView, int flags)
+    {
+        decorView.setSystemUiVisibility(flags);
+    }
+
+    /*
+    * Set the status bar color scheme hint so that the system decides how to color the icons.
+    */
+    @UsedFromNativeCode
+    static void setStatusBarColorHint(Activity activity, boolean isLight)
+    {
+        Window window = activity.getWindow();
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
+            WindowInsetsController controller = window.getInsetsController();
+            if (controller != null) {
+                int lightStatusBarMask = WindowInsetsController.APPEARANCE_LIGHT_STATUS_BARS;
+                int appearance = isLight ? lightStatusBarMask : 0;
+                controller.setSystemBarsAppearance(appearance, lightStatusBarMask);
+            }
+        } else {
+            @SuppressWarnings("deprecation")
+            int currentFlags = window.getDecorView().getSystemUiVisibility();
+            @SuppressWarnings("deprecation")
+            int lightStatusBarMask = View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR;
+            int appearance = isLight
+                ? currentFlags | lightStatusBarMask
+                : currentFlags & ~lightStatusBarMask;
+            setSystemUiVisibility(window.getDecorView(), appearance);
+        }
+    }
+
+    /*
+    * Set the navigation bar color scheme hint so that the system decides how to color the icons.
+    */
+    @UsedFromNativeCode
+    static void setNavigationBarColorHint(Activity activity, boolean isLight)
+    {
+        Window window = activity.getWindow();
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
+            WindowInsetsController controller = window.getInsetsController();
+            if (controller != null) {
+                int lightNavigationBarMask = WindowInsetsController.APPEARANCE_LIGHT_NAVIGATION_BARS;
+                int appearance = isLight ? lightNavigationBarMask : 0;
+                controller.setSystemBarsAppearance(appearance, lightNavigationBarMask);
+            }
+        } else {
+            @SuppressWarnings("deprecation")
+            int currentFlags = window.getDecorView().getSystemUiVisibility();
+            @SuppressWarnings("deprecation")
+            int lightNavigationBarMask = View.SYSTEM_UI_FLAG_LIGHT_NAVIGATION_BAR;
+            int appearance = isLight
+                ? currentFlags | lightNavigationBarMask
+                : currentFlags & ~lightNavigationBarMask;
+            setSystemUiVisibility(window.getDecorView(), appearance);
+        }
+    }
+
+    static int resolveColorAttribute(Activity activity, int attribute)
+    {
+        Theme theme = activity.getTheme();
+        Resources resources = activity.getResources();
+        TypedValue tv = new TypedValue();
+
+        if (theme.resolveAttribute(attribute, tv, true)) {
+            if (tv.resourceId != 0)
+                return resources.getColor(tv.resourceId, theme);
+            if (tv.type >= TypedValue.TYPE_FIRST_COLOR_INT && tv.type <= TypedValue.TYPE_LAST_COLOR_INT)
+                return tv.data;
+        }
+
+        return -1;
+    }
+
+    @SuppressWarnings("deprecation")
+    static int getThemeDefaultStatusBarColor(Activity activity)
+    {
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.VANILLA_ICE_CREAM)
+            return -1;
+        return resolveColorAttribute(activity, android.R.attr.statusBarColor);
+    }
+
+    @SuppressWarnings("deprecation")
+    static int getThemeDefaultNavigationBarColor(Activity activity)
+    {
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.VANILLA_ICE_CREAM)
+            return -1;
+        return resolveColorAttribute(activity, android.R.attr.navigationBarColor);
+    }
+
+    static void enableSystemBarsBackgroundDrawing(Window window)
+    {
+        // These are needed to operate on system bar colors
+        window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
+        @SuppressWarnings("deprecation")
+        final int translucentFlags =  WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS
+                                    | WindowManager.LayoutParams.FLAG_TRANSLUCENT_NAVIGATION;
+        window.clearFlags(translucentFlags);
+    }
+
+    @SuppressWarnings("deprecation")
+    static void setStatusBarColor(Window window, int color)
+    {
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.VANILLA_ICE_CREAM)
+            return;
+        window.setStatusBarColor(color);
+    }
+
+    @SuppressWarnings("deprecation")
+    static void setNavigationBarColor(Window window, int color)
+    {
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.VANILLA_ICE_CREAM)
+            return;
+        window.setNavigationBarColor(color);
+    }
+
     @SuppressWarnings("deprecation")
     static Display getDisplay(Context context)
     {
-- 
2.51.2

