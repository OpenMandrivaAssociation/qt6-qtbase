From 6a93bad4aa0cd791b3892c075356ba0d279c6d11 Mon Sep 17 00:00:00 2001
From: Marc Mutz <marc.mutz@qt.io>
Date: Thu, 23 Oct 2025 07:44:31 +0200
Subject: [PATCH 517/553] QUnicodeTools: port initScripts() to QStringIterator
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

After fixing the roundabout way of updating 'eor' in a previous
commit, this is now trivial (no nested loop).

Amends c20422af13fb30751eaa58e8755c7a9a7fd20a50.

Pick-to: 6.8 6.5
Change-Id: Idbbfc503f4bf3878d1fc57729224c99973bddc32
Reviewed-by: Edward Welbourne <edward.welbourne@qt.io>
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
(cherry picked from commit 4b4d44c56a2d821f1e25d4f20314b0d16b8c4e6f)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/corelib/text/qunicodetools.cpp | 14 ++++----------
 1 file changed, 4 insertions(+), 10 deletions(-)

diff --git a/src/corelib/text/qunicodetools.cpp b/src/corelib/text/qunicodetools.cpp
index d8f4d374322..b0c2036a5a1 100644
--- a/src/corelib/text/qunicodetools.cpp
+++ b/src/corelib/text/qunicodetools.cpp
@@ -2814,16 +2814,10 @@ Q_CORE_EXPORT void initScripts(QStringView string, ScriptItemArray *scripts)
     qsizetype sor = 0;
     QChar::Script script = QChar::Script_Common;
 
-    for (qsizetype i = 0; i < string.size(); ++i) {
-        const auto eor = i;
-        char32_t ucs4 = string[i].unicode();
-        if (QChar::isHighSurrogate(ucs4) && i + 1 < string.size()) {
-            ushort low = string[i + 1].unicode();
-            if (QChar::isLowSurrogate(low)) {
-                ucs4 = QChar::surrogateToUcs4(ucs4, low);
-                ++i;
-            }
-        }
+    QStringIterator it(string);
+    while (it.hasNext()) {
+        const auto eor = it.index();
+        const char32_t ucs4 = it.nextOrRawCodeUnit();
 
         const QUnicodeTables::Properties *prop = QUnicodeTables::properties(ucs4);
 
-- 
2.51.2

