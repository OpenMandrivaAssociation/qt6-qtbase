From e1969ec613234bae879a0847a13d25fe392a2115 Mon Sep 17 00:00:00 2001
From: Thiago Macieira <thiago.macieira@intel.com>
Date: Thu, 2 Oct 2025 21:00:04 -0700
Subject: [PATCH 482/553] QHostAddress: clear() the scopeId too
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Looks like this was forgotten since time immemorial. And not a lot
called QHostAddress::clear(), so we never noticed; it was definitely not
tested.

Drive-by move it to the header to make it inline.

Pick-to: 6.8 6.5
Change-Id: I2cdc8cf3cbbcb17ecc5ffffdb4257ce269813971
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
(cherry picked from commit d114a4f41b938738936cb8a2d513158c8fb93fc6)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/network/kernel/qhostaddress.cpp           |  7 ---
 src/network/kernel/qhostaddress_p.h           |  8 ++-
 .../kernel/qhostaddress/tst_qhostaddress.cpp  | 49 +++++++++++++++++++
 3 files changed, 56 insertions(+), 8 deletions(-)

diff --git a/src/network/kernel/qhostaddress.cpp b/src/network/kernel/qhostaddress.cpp
index 1bd3345a336..12522f28122 100644
--- a/src/network/kernel/qhostaddress.cpp
+++ b/src/network/kernel/qhostaddress.cpp
@@ -140,13 +140,6 @@ bool QHostAddressPrivate::parse(const QString &ipString)
     return false;
 }
 
-void QHostAddressPrivate::clear()
-{
-    a = 0;
-    protocol = QHostAddress::UnknownNetworkLayerProtocol;
-    memset(&a6, 0, sizeof(a6));
-}
-
 AddressClassification QHostAddressPrivate::classify() const
 {
     if (a) {
diff --git a/src/network/kernel/qhostaddress_p.h b/src/network/kernel/qhostaddress_p.h
index 6cc28cd5a9b..608080e9ede 100644
--- a/src/network/kernel/qhostaddress_p.h
+++ b/src/network/kernel/qhostaddress_p.h
@@ -74,7 +74,13 @@ public:
     void setAddress(const Q_IPV6ADDR &a_);
 
     bool parse(const QString &ipString);
-    void clear();
+    void clear()
+    {
+        a6 = {};
+        a = 0;
+        protocol = QHostAddress::UnknownNetworkLayerProtocol;
+        scopeId.clear();
+    }
 
     QString scopeId;
 
diff --git a/tests/auto/network/kernel/qhostaddress/tst_qhostaddress.cpp b/tests/auto/network/kernel/qhostaddress/tst_qhostaddress.cpp
index 0d2b7bfde64..bbeb445096d 100644
--- a/tests/auto/network/kernel/qhostaddress/tst_qhostaddress.cpp
+++ b/tests/auto/network/kernel/qhostaddress/tst_qhostaddress.cpp
@@ -30,6 +30,7 @@ public:
     tst_QHostAddress();
 
 private slots:
+    void constructor();
     void constructor_QString_data();
     void constructor_QString();
     void setAddress_QString_data();
@@ -62,6 +63,43 @@ tst_QHostAddress::tst_QHostAddress()
     qRegisterMetaType<QHostAddress>("QHostAddress");
 }
 
+static void verifyClear(const QHostAddress &addr)
+{
+    QVERIFY(addr.isNull());
+    QVERIFY(!addr.isLoopback());
+    QVERIFY(!addr.isGlobal());
+    QVERIFY(!addr.isLinkLocal());
+    QVERIFY(!addr.isSiteLocal());
+    QVERIFY(!addr.isUniqueLocalUnicast());
+    QVERIFY(!addr.isMulticast());
+    QVERIFY(!addr.isBroadcast());
+    QVERIFY(!addr.isPrivateUse());
+    QCOMPARE(addr, QHostAddress());
+    QCOMPARE(addr, QHostAddress::Null);
+    QCOMPARE(addr.protocol(), QHostAddress::UnknownNetworkLayerProtocol);
+
+    bool ok = true;
+    QCOMPARE(addr.toIPv4Address(&ok), 0);
+    QVERIFY(!ok);
+
+    QCOMPARE(QByteArrayView::fromArray(addr.toIPv6Address().c),
+             QByteArrayView::fromArray(QIPv6Address{}.c));
+    QCOMPARE(addr.scopeId(), QString());
+
+    QCOMPARE(addr.toString(), QString());
+
+    size_t seed = QHashSeed::globalSeed();
+    QCOMPARE(qHash(addr, seed), qHash(QHostAddress(), seed));
+    seed = 0;
+    QCOMPARE(qHash(addr, seed), qHash(QHostAddress(), seed));
+}
+
+void tst_QHostAddress::constructor()
+{
+    QHostAddress addr;
+    verifyClear(addr);
+}
+
 void tst_QHostAddress::constructor_QString_data()
 {
     setAddress_QString_data();
@@ -94,6 +132,9 @@ void tst_QHostAddress::constructor_QString()
         QVERIFY( hostAddr.isNull() );
         QVERIFY( hostAddr.protocol() == QHostAddress::UnknownNetworkLayerProtocol );
     }
+
+    hostAddr.clear();
+    verifyClear(hostAddr);
 }
 
 void tst_QHostAddress::setAddress_QString_data()
@@ -201,6 +242,9 @@ void tst_QHostAddress::setAddress_QString()
         QVERIFY( hostAddr.isNull() );
         QVERIFY( hostAddr.protocol() == QHostAddress::UnknownNetworkLayerProtocol );
     }
+
+    hostAddr.clear();
+    verifyClear(hostAddr);
 }
 
 void tst_QHostAddress::specialAddresses_data()
@@ -370,6 +414,11 @@ void tst_QHostAddress::scopeId()
     address2 = address;
     QCOMPARE(address2.scopeId(), QString("eth0"));
     QCOMPARE(address2.toString().toLower(), QString("fe80::2e0:4cff:fefb:662a%eth0"));
+
+    address.clear();
+    verifyClear(address);
+    address2.clear();
+    verifyClear(address2);
 }
 
 void tst_QHostAddress::hashKey()
-- 
2.51.2

