From 95a267d86731a923ba919929a7a73c9ed3cc6314 Mon Sep 17 00:00:00 2001
From: Thiago Macieira <thiago.macieira@intel.com>
Date: Fri, 15 Aug 2025 15:39:25 -0700
Subject: [PATCH 087/553] QStringConverter: allow appendToBuffer() to write to
 the buffer
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Even if we later decide that the data we wrote was incomplete. This
allows us to use the buffer as a scratch area, improving performance. I
need this for a faster SIMD encoding, because it stores a tentative
conversion to US-ASCII before searching where the last valid conversion
was. I was getting:

   Actual   (buffer)    : "\x00""dcdcdcd"
   Expected ("cdcdcdcd"): cdcdcdcd

Amends the tests added by f1c0bd2e06fdee87b255d790a42a361f3433cf24 for
finalize().

[ChangeLog][Important Behavior Change] The appendToBuffer() functions
in QStringEncoder and QStringDecoder may write to parts of the
provided output beyond the returned pointer. Caller code must not
assume the data beyond that remains unmodified.

Pick-to: 6.9 6.8
Change-Id: If59c4017cac9ee82ca45fffd29cceb9832ae98e5
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
Reviewed-by: Fabian Kosmale <fabian.kosmale@qt.io>
(cherry picked from commit 23ec36d1b23a866771ada3a6f2cd47217fecad2c)
---
 src/corelib/text/qstringconverter.cpp | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/corelib/text/qstringconverter.cpp b/src/corelib/text/qstringconverter.cpp
index fd589ba81f3..97b93a1cde3 100644
--- a/src/corelib/text/qstringconverter.cpp
+++ b/src/corelib/text/qstringconverter.cpp
@@ -2788,7 +2788,8 @@ const char *QStringConverter::nameForEncoding(QStringConverter::Encoding e) noex
 
     \note \a out must be large enough to be able to hold all the decoded data. Use
     requiredSpace() to determine the maximum size requirement to be able to encode
-    \a in.
+    \a in. This function may write to any bytes between \a out and \c{out +
+    requiredSpace()}, including those past the returned end pointer.
 
     \sa requiredSpace()
 */
@@ -2884,7 +2885,9 @@ const char *QStringConverter::nameForEncoding(QStringConverter::Encoding e) noex
 
     \a out needs to be large enough to be able to hold all the decoded data. Use
     \l{requiredSpace} to determine the maximum size requirements to decode an encoded
-    data buffer of \c in.size() bytes.
+    data buffer of \c in.size() bytes. This function may write to any bytes
+    between \a out and \c{out + requiredSpace()}, including those past the
+    returned end pointer.
 
     \sa requiredSpace
 */
-- 
2.51.2

